<?xml version="1.0" encoding="UTF-8"?>

<!--
  Copyright 2011-2019, by the California Institute of Technology.
  ALL RIGHTS RESERVED. United States Government Sponsorship acknowledged.
  Any commercial use must be negotiated with the Office of Technology Transfer
  at the California Institute of Technology.

  This software is subject to U. S. export control laws and regulations
  (22 C.F.R. 120-130 and 15 C.F.R. 730-774). To the extent that the software
  is subject to U.S. export control laws and regulations, the recipient has
  the responsibility to obtain export licenses or other export authority as
  may be required before exporting such information to foreign countries or
  providing access to foreign nationals.

  $Id$
-->

<document>
  <properties>
    <title>Installation</title>
    <author email="Hyun.H.Lee@jpl.nasa.gov">Hyun Lee</author>
    <author email="Jordan.Padams@jpl.nasa.gov">Jordan Padams</author>
    <author email="Sean.Hardman@jpl.nasa.gov">Sean Hardman</author>
  </properties>

  <body>
    <section name="Installation">
      <p>This document describes how to install the Registry software contained in the <i>${project.artifactId}</i> package. The following topics can be found in this section:
      </p>

      <ul>
        <li><a href="#System_Requirements">System Requirements</a></li>
        <li><a href="#Unpacking_the_Package">Unpacking the Package</a></li>
        <li><a href="#Install_Solr_and_Search_Service">Install Solr and Search Service</a></li>
        <li><a href="#Install_Solr_and Search_Service_in_Docker">Install Solr and Search Service in Docker</a></li>
        <li><a href="#Common_Errors">Common Errors</a></li>
      </ul>
    </section>

    <section name="System Requirements">
      <p>This section details the system requirements for installing and operating the Registry.
      </p>

      <subsection name="Java Runtime Environment">
        <p>The Registry was developed using Java and will run on any platform with a supported Java Runtime Environment (JRE). The software was specifically compiled for and tested in Java version 1.8. The following commands test the local Java installation in a UNIX-based environment:
        </p>

        <source>
% which java
/usr/bin/java

% java -version
java version "1.8.0_101"
Java(TM) SE Runtime Environment (build 1.8.0_101-b13)
Java HotSpot(TM) 64-Bit Server VM (build 25.101-b13, mixed mode)
        </source>

        <p>The first command above checks whether the <i>java</i> executable is in the environment's path and the second command reports the version. If Java is not installed or the version is not at least 1.8, Java will need to be downloaded and installed in the current environment. Consult the local system administrator for installation of this software. For the do-it-yourself crowd, the Java software can be downloaded from the <a href="http://www.oracle.com/technetwork/java/javase/downloads/" target="_blank">Oracle Java Download</a> page. The suggested software package is the Java Standard Edition (SE) 8, either the JDK or the JRE package. The JDK package is not necessary to run the software but could be useful if development and compilation of Java software will also occur in the current environment.
        </p>
      </subsection>

      <subsection name="Solr Server">
        <p>The Search Service requires a Solr server. The suggested Solr server for this release is a minimal version of 7.5.0. Consult the local system administrator for installation of this software. For the do-it-yourself crowd, see the <a href="http://lucene.apache.org/solr/guide/7_5/solr-tutorial.html" target="_blank">Solr tutorial</a> document for installation and configuration detail.</p>

        <p>The top-level directory where Solr is installed (i.e. the directory containing the <i>server</i> and <i>dist</i> sub-directories) will be referenced in these instructions as <i><b>$SOLR_HOME</b></i>.
        </p>
      </subsection>
    </section>

    <section name="Unpacking the Package">
      <p>Download the <i>${project.artifactId}</i> package from the PDS <a href="ftp://pds.nasa.gov/pub/toplevel/2010/search/" target="_blank">FTP</a> site. The binary distribution is available in identical zip or tar/gzip packages. The installation directory may vary from environment to environment but in UNIX-based environments it is typical to install software packages in the <i>/home/pds</i> directory and in Windows-based environments it is typical to install software packages in the <i>C:\Program Files</i> directory. Unpack the selected binary distribution file with one of the following commands:
      </p>

      <p>The top-level directory where the package is installed will be referenced in these instructions as <i><b>$SEARCH_HOME</b></i>.</p>
      <source>
% unzip ${project.artifactId}-${project.version}-bin.zip
or
% tar -xzvf ${project.artifactId}-${project.version}-bin.tar.gz
      </source>

      <p>Note: Depending on the platform, the native version of <i>tar</i> may produce an error when attempting to unpack the distribution file because many of the file paths are greater than 100 characters. If available, the GNU version of tar will resolve this problem. If that is not available or cannot be installed, the zipped package will work just fine in a UNIX environment.
      </p>

      <p>The commands above result in the creation of the <i>${project.artifactId}-${project.version}</i> directory with the following directory structure:
      </p>

      <ul>
        <li><b>LICENSE.txt</b><br/>
          <p>The copyright notice from the <a href="http://www.caltech.edu/" target="_blank">California Institute of Technology</a> detailing the restrictions regarding the use and distribution of this software. Although the license is strictly worded, the software has been classified as Technology and Software Publicly Available (TSPA) and is available for <i>anyone</i> to download and use.
          </p>
        </li>
        <li><b>README.txt</b><br/>
          <p>A README file directing the user to the available documentation for the project.
          </p>
        </li>
        <li><b>VERSION.txt</b><br/>
          <p>A VERSION file contains the version of the project.
          </p>
        </li>
        <li><b>bin/</b><br />
          <p>This directory contains the scripts for installing or uninstalling.</p>
        </li>
        <li><b>build/</b><br />
          <p>This directory contains the scripts for installing or uninstalling the project in Docker. </p>
        </li>
        <li><b>dist/</b><br />
          <p>This directory contains the jar for the Registry API (PDS Search Protocol).</p>
        </li>
        <li><b>conf/</b><br />
          <p>This directory contains the configuration for the SOLR core for the PDS Search.  This directory path is the SEARCH_HOME referenced in the <a href="../../search-core/operate/index.html">Search Core Operation documentation</a>
          </p>
        </li>
        <li><b>lib/</b><br />
          <p>This directory contains the jars used by the SOLR to parse XSLT.</p>
        </li>
      </ul>
    </section>

    <section name="Install Solr and Search Service">
      <p>The Registry includes the configuration for Solr as well as the Java extensions written to support the PDS Search Protocol and PDAP Handler. In order to deploy Solr with the Registry configuration, please complete the following procedure:
      </p>

      <subsection name="SOLR Installation">
        <ol>
          <li>
            <p>Install SOLR as indicated in <a href="http://lucene.apache.org/solr/guide/7_6/installing-solr.html" target="_blank">Installing SOLR</a> document.</p>
            <p>Unpack SOLR pkg</p>
            <source>
% tar xvf solr-7.6.0.tgz
% cd solr-7.6.0
            </source>      
          	<p>NOTE: Remember the location of SOLR installation for later steps.</p>
          </li>
        </ol>
      </subsection>
      
      <subsection name="Search Service Installation for MAC users">
        <ol>
          <li>Move to the directory that search service installer script resides.
            <source>
% cd $SEARCH_HOME/bin
            </source>
          </li>
          <li>Execute a search service installer script.
            <source>
% ./search_install.sh
            </source>
          </li>
          <li>Enter the harvest installation location, install mode and SOLR installation location that is done in previous step.
            <source>
Enter location of Harvest installation: /home/pds
Enter an installation mode (docker or standalone): standalone

Enter location of SOLR installation: /home/pds/solr-7.6.0
            </source>
            
             <p>You should see output similar to the following: </p>
          
          <source>
Harvest installation location -  /home/pds
STARTING Search Service Installer in standalone mode.

  Search Service   .....   
       ( v 2.0.0 )
       ( installing on platform: Mac OS X )
       ( IP Address:- 192.168.1.65 )
       ( Host Name:- MT-106917 )

Enter location of SOLR installation: /Users/pds/SOLR/solr-7.6.0 
 Copied a directory from /Users/pds/search-service/target/search-service-2.0.0/bin/../dist to /Users/pds/SOLR/solr-7.6.0/contrib/pds/lib
 Copied a directory from /Users/pds/search-service/target/search-service-2.0.0/bin/../conf to /Users/pds/SOLR/solr-7.6.0/server/solr/configsets/pds/conf
 Copied a file from /Users/pds/search-service/target/search-service-2.0.0/bin/../lib/saxon-9.jar to /Users/pds/SOLR/solr-7.6.0/server/solr-webapp/webapp/WEB-INF/lib/saxon-9.jar
 Copied a file from /Users/pds/search-service/target/search-service-2.0.0/bin/../lib/saxon-dom-9.jar to /Users/pds/SOLR/solr-7.6.0/server/solr-webapp/webapp/WEB-INF/lib/saxon-dom-9.jar

Starting a SOLR server ....Waiting up to 180 seconds to see Solr running on port 8983....
*** [WARN] *** Your open file limit is currently 10240.  
 It should be set to 65000 to avoid operational disruption. 
 If you no longer wish to see this warning, set SOLR_ULIMIT_CHECKS to false in your profile or solr.in.sh
*** [WARN] ***  Your Max Processes Limit is currently 1418. 
 It should be set to 65000 to avoid operational disruption. 
 If you no longer wish to see this warning, set SOLR_ULIMIT_CHECKS to false in your profile or solr.in.sh
Waiting up to 180 seconds to see Solr running on port 8983 [-]  
Started Solr server on port 8983 (pid=67836). Happy searching!

    
Return status from the SOLR server startup = 0
The SOLR server is started successfully.
Creating Registry Service collection (.system) ...
{
  "responseHeader":{
    "status":400,
    "QTime":45},
  "Operation create caused exception:":"org.apache.solr.common.SolrException:org.apache.solr.common.SolrException: collection already exists: .system",
  "exception":{
    "msg":"collection already exists: .system",
    "rspCode":400},
  "error":{
    "metadata":[
      "error-class","org.apache.solr.common.SolrException",
      "root-error-class","org.apache.solr.common.SolrException"],
    "msg":"collection already exists: .system",
    "code":400}}
Return status from creating registry service collection (.system) = 0
Registry service collection (.system) is created successfully.
{
  "responseHeader":{
    "status":0,
    "QTime":122}}
Return status from creating registry service collection alias = 0
Registry service collection alias (.system) is created successfully.
Creating Registry Service collection (xpath) ...
{
  "responseHeader":{
    "status":0,
    "QTime":3528},
  "success":{
    "192.168.1.65:8983_solr":{
      "responseHeader":{
        "status":0,
        "QTime":1881},
      "core":"xpath_shard1_replica_n1"}},
  "warning":"Using _default configset. Data driven schema functionality is enabled by default, which is NOT RECOMMENDED for production use. To turn it off: curl http://{host:port}/solr/xpath/config -d '{\"set-user-property\": {\"update.autoCreateFields\":\"false\"}}'"}
Registry service collection (xpath) is created successfully.
{
  "responseHeader":{
    "status":0,
    "QTime":120}}
Registry service collection alias (xpath) is created successfully.
Creating Search Service collection (pds) ...
Created collection 'pds' with 1 shard(s), 1 replica(s) with config-set 'pds'
Return status from creating search service collection = 0
Search service collection (pds) is created successfully.

          </source>        
          </li>
          <li>Verify installation.
            <p>Open up your favorite browser and type in <i>http://localhost:8983/solr</i>. You should see the Solr admin interface.
            </p>
          </li>
        </ol>
      </subsection> 
      
      <subsection name="Search Service Installation for Windows users">
        <ol>
          <li>Open Command Prompt via the <b><i>'Command Prompt'</i></b> executable.
          </li>
          <p>
          </p>
          
          <li>Move to the directory that search service installer script resides.
            <source>
% cd %SEARCH_HOME%\bin
            </source>
          </li>
          <li>Execute a search service installer script.
            <source>
% search_install.bat
            </source>
          </li>
          <li>Enter the harvest installation location, install mode and SOLR installation location that is done in previous step.
            <source>
Enter location of Harvest installation: C:\home\pds
Enter an installation mode (docker or standalone): standalone

Enter location of SOLR installation: C:\home\pds\solr-7.6.0
            </source>
            
             <p>You should see output similar to the following: </p>
          
          <source>
Harvest installation location -  C:\home\pds
STARTING Search Service Installer in standalone mode.

  Search Service   .....   
       ( v 2.0.0 )
       ( installing on platform: Windows 7 )
       ( IP Address:- 192.168.1.65 )
       ( Host Name:- PDS-HP )

Enter location of SOLR installation: C:\Users\pds\solr-7.6.0
 Copied a directory from C:\Users\pds\search-service-2.0.0\bin\..\dist to C:\Users\pds\solr-7.6.0\contrib\pds\lib
 Copied a directory from C:\Users\pds\search-service-2.0.0\bin\..\conf to C:\Users\pds\solr-7.6.0\server\solr\configs
ets\pds\conf
 Copied a file from C:\Users\pds\search-service-2.0.0\bin\..\lib\saxon-9.jar to C:\Users\pds\solr-7.6.0\server\solr-w
ebapp\webapp\WEB-INF\lib\saxon-9.jar
 Copied a file from C:\Users\pds\search-service-2.0.0\bin\..\lib\saxon-dom-9.jar to C:\Users\pds\solr-7.6.0\server\so
lr-webapp\webapp\WEB-INF\lib\saxon-dom-9.jar

Starting a SOLR server ....Waiting up to 180 seconds to see Solr running on port 8983....
SOLR server is started on Windows 7
Creating Registry Service collection (.system) ...
{
  "responseHeader":{
    "status":0,
    "QTime":11259},
  "success":{
    "169.254.193.90:8983_solr":{
      "responseHeader":{
        "status":0,
        "QTime":7562},
      "core":".system_shard1_replica_n1"}},
  "warning":"Using _default configset. Data driven schema functionality is enabled by default, which is NOT RECOMMENDED for production use. To turn it off: curl http://{host:port}/solr/.system/config -d '{\"set-user-property\": {\"update.autoCreateFields\":\"false\"}}'"}
Return status from creating registry service collection (.system) = 0
Registry service collection (.system) is created successfully.
{
  "responseHeader":{
    "status":0,
    "QTime":384}}
Return status from creating registry service collection alias = 0
Registry service collection alias (.system) is created successfully.
Creating Registry Service collection (xpath) ...
{
  "responseHeader":{
    "status":0,
    "QTime":17582},
  "success":{
    "169.254.193.90:8983_solr":{
      "responseHeader":{
        "status":0,
        "QTime":13858},
      "core":"xpath_shard1_replica_n1"}},
  "warning":"Using _default configset. Data driven schema functionality is enabled by default, which is NOT RECOMMENDED for production use. To turn it off: curl http://{host:port}/solr/xpath/config -d '{\"set-user-property\": {\"update.autoCreateFields\":\"false\"}}'"}
Registry service collection (xpath) is created successfully.
{
  "responseHeader":{
    "status":0,
    "QTime":355}}
Registry service collection alias (xpath) is created successfully.
Creating Search Service collection (pds) ...
Created collection 'pds' with 1 shard(s), 1 replica(s) with config-set 'pds'
Return status from creating search service collection = 0
Search service collection (pds) is created successfully.

          </source>        
          </li>
          <li>Verify installation.
            <p>Open up your favorite browser and type in <i>http://localhost:8983/solr</i>. You should see the Solr admin interface.
            </p>
          </li>
        </ol>
      </subsection>        
    </section>

    <section name="Install Solr and Search Service in Docker">
      <p>This section details how to install and deploy a dockerized instance of the PDS Search Service. It has been separated into 3 sections depending on the target platform.
      </p>
      
      <subsection name="MAC Users">
        <p>Note that this installation is still in its experimental stages and has not been fully tested.
        </p>

        <ol>
          <li>
            <p>Install and Run Docker Desktop for Mac as indicated in <a href="https://docs.docker.com/docker-for-mac/install/" target="_blank">Install Docker Desktop for Mac</a> website if your system doesn't have Docker.</p>
          </li>
          
          <li>Move to the directory that search service installer script resides.
            <source>
% cd $SEARCH_HOME/bin
            </source>
          </li>
          <li>Execute a search service installer script.
            <source>
% ./search_install.sh
            </source>
          </li>
          <li>Enter the harvest installation location and install mode (docker).
            <source>
Enter location of Harvest installation: /home/pds
Enter an installation mode (docker or standalone): docker
            </source>
                     
            <p>You should see output similar to the following:
          </p>

          <source>
Harvest installation location -  /home/pds
STARTING Search Service Installer in docker mode.

  Search Service   .....   
       ( v 2.0.0 )
       ( installing on platform: Mac OS X )
       ( IP Address:- 192.168.1.65 )
       ( Host Name:- MT-106917 )

Execute to install Registry/Search Services in Docker...
Building Registry/Search Docker Image.                               SUCCESS
Starting Registry/Search Docker Container.                           SUCCESS
Waiting for Solr server to start (60 seconds)...
Creating a Registry Service Blob collection (.system)                SUCCESS
Creating a Registry Service XPath collection (xpath)                 SUCCESS
Creating a Search Service collection (pds)                           SUCCESS
Completed to install Registry/Search Services in Docker.

          </source>     
          </li>  
          <li>Verify installation.
            <p>Open up your favorite browser and type in <i>http://localhost:8983/solr</i>. You should see the Solr admin interface.
            </p>
          </li>
        </ol>
      </subsection>
      
      <subsection name="Linux Users">
        <ol>
          <p>NOTE: Make sure that there is a Docker installation and up and running on the platform.</p>
          
          <li>Move to the directory that search service installer script resides.
            <source>
% cd $SEARCH_HOME/bin
            </source>
          </li>
          <li>Execute a search service installer script.
            <source>
% ./search_install.sh
            </source>
          </li>
          <li>Enter the harvest installation location and install mode (docker).
            <source>
Enter location of Harvest installation: /home/pds
Enter an installation mode (docker or standalone): docker
            </source>
           
            <p>You should see output similar to the following:
          </p>

          <source>
Enter location of Harvest installation: /home/pds
Enter an installation mode (docker or standalone): docker
Harvest installation location -  /home/pds
STARTING Search Service Installer in docker mode.

  Search Service   .....   ( v 2.0.0 )
                           ( installing on platform: Linux )
                           ( IP Address:- 192.168.1.65 )
       					   ( Host Name:- pds )

Installing Registry/Search Services in Docker...
Building Registry/Search Docker Image.                               SUCCESS
Starting Registry/Search Docker Container.                           SUCCESS
Waiting for Solr server to start (30 seconds)...
Creating a Registry Service Blob collection (.system)                SUCCESS
Creating a Registry Service XPath collection (xpath)                 SUCCESS
Creating a Search Service collection (pds)                           
Completed to install Registry/Search Services in Docker.

          </source>     
          </li>  
          <li>Verify installation.
            <p>Open up your favorite browser and type in <i>http://localhost:8983/solr</i>. You should see the Solr admin interface.
            </p>
          </li>
        </ol>
      </subsection>
      
      <subsection name="Windows Users">
        <p>Note that this installation is still in its experimental stages and has not been fully tested.
        </p>
                
        <ol>
          <li>Install Curl if needed.
          
          <p>If Curl needs to be installed on the target Windows machine, it can be downloaded from the <a href="https://curl.haxx.se/windows/">Curl</a> website. Make sure that the <i>PATH</i> environment references the bin/ folder in the Curl directory(i.e. C:\path\to\curl\bin).
          </p>
          
          </li>
        
          <li>Install Docker Toolbox.
          
          <p>Install Docker Toolbox from the <a href="https://docs.docker.com/toolbox/toolbox_install_windows/">Docker</a> website.
          </p>
          
          </li>
          
          <li>Configure the VM.
          
          <p><i>Oracle VM VirtualBox</i> should have been installed from step 1). Open up this application by clicking on the <i>Oracle VM VirtualBox Manager</i> icon. The VM settings configured for Docker should be optimized to boost the performance of the Search Service. To do this, right-click on the VM that is labeled <i>default</i>, then click on <i>Settings</i>.
          </p>
          
          <p>Once inside the Settings window, click on <i>System</i> and in the <i>Motherboard</i> tab, increase the Base Memory accordingly:
          </p>
          
          <center><img src="../images/system-memory-setting.jpg"/></center>
          
          <p>Next, click on the <i>Processor</i> tab and increase the number of Processors to use for the VM:
          </p>
          
          <center><img src="../images/system-processor-setting.jpg"/></center>         
          
          <p>Click on the <i>Network</i> menu icon, click the arrow next to the <i>Advanced</i> section, and click on the <i>Port Forwarding</i> button.
          </p>
          
          <center><img src="../images/virtual-box-network-settings.jpg"/></center>           
          
          <p>Add a new Port Forwarding rule, by clicking on the <i>+</i> icon on the right. Set the Name field to <i>Registry</i>, and set the Host Port and Guest Port fields to <i>8983</i>.
          </p>
          
          <center><img src="../images/port-forward-rule.jpg"/></center>              
          
          </li>
          
          <li>Once the VM is configured, click on the <i>Docker Quickstart Terminal</i> Windows icon.
          
          <p>
          </p>
          
          </li>
          
          <li>Run the search service installer script via the Docker Terminal. 
          
          <p>The Docker Terminal runs in a Linux-like environment. The VM mounts the user's home directory and it can be accessed in a Linux-style path. So <i>C:\Users\PDS_User</i> can be accessed through this Terminal Window like so: <i>/c/Users/PDS_User</i>.
          </p>
          
          <p>It is recommended that the Registry package be installed under the user's home directory. Assuming that the Registry package is installed under C:\Users\PDS_User\search-service, do the following:
          </p>
          
          <source>
% cd /c/Users/PDS_User/search-service/bin

% ./search_install.sh
          </source>
          
          <p>You should see output similar to the following:
          </p>
          
          <source>
          
Harvest installation location -  /c/Users/PDS_User/registry
STARTING Search Service Installer in docker mode.

  Search Service   .....   
       ( v 2.0.0 )
       ( installing on platform: Windows 7 )
       ( IP Address:- 192.168.1.65 )
       ( Host Name:- MT-106917 )

Execute to install Registry/Search Services in Docker...
Building Registry/Search Docker Image.                               SUCCESS
Starting Registry/Search Docker Container.                           SUCCESS
Waiting for Solr server to start (60 seconds)...
Creating a Registry Service Blob collection (.system)                SUCCESS
Creating a Registry Service XPath collection (xpath)                 SUCCESS
Creating a Search Service collection (pds)                           SUCCESS
Completed to install Registry/Search Services in Docker.

          </source>         
          </li>
          
          <li>Verify installation.
          
          <p>Open up your favorite browser and type in <i>http://localhost:8983/solr</i>. You should see the Solr admin interface.
          </p>
          
          </li>
   
        </ol>
        
        <p>When the deploy script is run, it will output a log file. In this log file, it is expected to see the following message:
        </p>
        
        <source>
SECURITY WARNING: You are building a Docker image from Windows against a non-Windows Docker host. \
All files and directories added to build context will have '-rwxr-xr-x' permissions. \
It is recommended to double check and reset permissions for sensitive files and directories.        
        </source>
        
        <p>At the time of this writing, it is unknown what the cause of this issue is. It does not appear to affect the Registry in the testing that was performed.
        </p>
      
      </subsection>
      
      
    </section>

    <section name="Common Errors">
      <subsection name="HTTP 404 - Requested Resource Not Available">
        <p>This error means the application failed to install correctly. The following are potential mitigation strategies:
        </p>
        <ul>
          <li>Verify domain and port are correct for the local Solr installation.</li>
          <li>View $SOLR_HOME/server/logs/solr.log for information on potential causes of the failed deployment.</li>
        </ul>
      </subsection>

      <subsection name="Other Errors">
        <p>For other errors that arise while testing the installation, see the <a href="../operate/index.html#Common_Errors">Operate - Common Errors</a></p>
      </subsection>
    </section>
  </body>
</document>
