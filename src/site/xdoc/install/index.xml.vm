<?xml version="1.0" encoding="UTF-8"?>

<!--
  Copyright 2019, California Institute of Technology ("Caltech").
  U.S. Government sponsorship acknowledged.
  
  All rights reserved.
  
  Redistribution and use in source and binary forms, with or without
  modification, are permitted provided that the following conditions are met:
  
  * Redistributions of source code must retain the above copyright notice,
  this list of conditions and the following disclaimer.
  * Redistributions must reproduce the above copyright notice, this list of
  conditions and the following disclaimer in the documentation and/or other
  materials provided with the distribution.
  * Neither the name of Caltech nor its operating division, the Jet Propulsion
  Laboratory, nor the names of its contributors may be used to endorse or
  promote products derived from this software without specific prior written
  permission.
  
  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
  POSSIBILITY OF SUCH DAMAGE.
-->

<document>
  <properties>
    <title>Installation</title>
    <author email="Hyun.H.Lee@jpl.nasa.gov">Hyun Lee</author>
    <author email="Jordan.Padams@jpl.nasa.gov">Jordan Padams</author>
    <author email="Sean.Hardman@jpl.nasa.gov">Sean Hardman</author>
  </properties>

  <body>
    <section name="Installation">
      <p>This document describes how to install the Registry software contained in the <i>${project.artifactId}</i> package. The following topics can be found in this section:
      </p>

      <ul>
        <li><a href="#System_Requirements">System Requirements</a></li>
        <li><a href="#Unpacking_the_Package">Unpacking the Package</a></li>
        <li><a href="#Install_Solr_and_Registry_-_Docker">Install Solr and Registry - Docker</a> (preferred method)</li>
        <li><a href="#Install_Solr_and_Registry_-_Standalone">Install Solr and Registry - Standalone</a></li>
        <li><a href="#Operational_Deployment">Operational Deployment</a></li>
        <li><a href="#Next_Steps">Next Steps</a></li>
        <li><a href="#Common_Errors">Common Errors</a></li>
      </ul>
    </section>

    <section name="System Requirements">
      <p>This section details the system requirements for installing and operating the Registry.
      </p>

      <subsection name="Java Runtime Environment">
        <p>The Registry was developed using Java and will run on any platform with a supported Java Runtime Environment (JRE). The software was specifically compiled for and tested in Java version 1.8 (64-bit). The following commands test the local Java installation in a UNIX-based environment:
        </p>

	<p>NOTE: This software only works with 64-bit Java installation.</p>

        <source>
% which java
/usr/bin/java

% java -version
java version "1.8.0_101"
Java(TM) SE Runtime Environment (build 1.8.0_101-b13)
Java HotSpot(TM) 64-Bit Server VM (build 25.101-b13, mixed mode)
        </source>

        <p>The first command above checks whether the <i>java</i> executable is in the environment's path and the second command reports the version. If Java is not installed or the version is not at least 1.8, Java will need to be downloaded and installed in the current environment. Consult the local system administrator for installation of this software. For the do-it-yourself crowd, the Java software can be downloaded from the <a href="http://www.oracle.com/technetwork/java/javase/downloads/" target="_blank">Oracle Java Download</a> page. The suggested software package is the Java Standard Edition (SE) 8, either the JDK or the JRE package. The JDK package is not necessary to run the software but could be useful if development and compilation of Java software will also occur in the current environment.
        </p>
      </subsection>
      
      <subsection name="Memory Requirements">
	<ol>
	  <ul>The Registry requires >2GB memory available in order to perform normal operations</ul>
	</ol>
      </subsection>
    </section>

    <section name="Unpacking the Package">
      <p>Download the <i>${project.artifactId}</i> package from the PDS FTP site (<a href="ftp://pds.nasa.gov/pub/toplevel/2010/search/${project.artifactId}-${project.version}-bin.tar.gz" target="_blank">TAR.GZ</a> <a href="ftp://pds.nasa.gov/pub/toplevel/2010/search/${project.artifactId}-${project.version}-bin.tar.gz" target="_blank">ZIP</a>). The binary distribution is available in identical zip or tar/gzip packages. The installation directory may vary from environment to environment but in UNIX-based environments it is typical to install software packages in the <i>/home/pds</i> directory and in Windows-based environments it is typical to install software packages in the <i>C:\Program Files</i> directory. Unpack the selected binary distribution file with one of the following commands:
      </p>

      <p>The top-level directory where the package is installed will be referenced in these instructions as <i><b>$REGISTRY_HOME</b></i>.</p>
      <source>
% unzip ${project.artifactId}-${project.version}-bin.zip
or
% tar -xzvf ${project.artifactId}-${project.version}-bin.tar.gz

# Set the REGISTRY_HOME variable.
% cd ${project.artifactId}-${project.version}

# On Linux and Mac (Bash shell only. Update accordingly for other shells.)
% export REGISTRY_HOME=$(pwd)

# On Windows
% set "REGISTRY_HOME=%cd%"
      </source>

      <p>Note: Depending on the platform, the native version of <i>tar</i> may produce an error when attempting to unpack the distribution file because many of the file paths are greater than 100 characters. If available, the GNU version of tar will resolve this problem. If that is not available or cannot be installed, the zipped package will work just fine in a UNIX environment.
      </p>

      <p>The commands above result in the creation of the <i>${project.artifactId}-${project.version}</i> directory with the following directory structure:
      </p>

      <ul>
        <li><b>LICENSE.txt</b><br/>
          <p>The copyright notice from the <a href="http://www.caltech.edu/" target="_blank">California Institute of Technology</a> detailing the restrictions regarding the use and distribution of this software. Although the license is strictly worded, the software has been classified as Technology and Software Publicly Available (TSPA) and is available for <i>anyone</i> to download and use.
          </p>
        </li>
        <li><b>README.txt</b><br/>
          <p>A README file directing the user to the available documentation for the project.
          </p>
        </li>
        <li><b>VERSION.txt</b><br/>
          <p>A VERSION file contains the version of the project.
          </p>
        </li>
        <li><b>bin/</b><br />
          <p>This directory contains the scripts for installing or uninstalling.</p>
        </li>
        <li><b>build/</b><br />
          <p>This directory contains the scripts for installing or uninstalling the project in Docker. </p>
        </li>
        <li><b>dist/</b><br />
          <p>This directory contains the jar for the Registry API (PDS Search Protocol).</p>
        </li>
        <li><b>conf/</b><br />
          <p>This directory contains the configuration for Apache Solr. This is where you can make updates to the Solr schema and solrconfig.xml.
          </p>
        </li>
        <li><b>lib/</b><br />
          <p>This directory contains the jars used by the Solr to parse XSLT.</p>
        </li>
      </ul>
    </section>

    <section name="Install Solr and Registry - Docker">
      <p><b>NOTE: Docker installation is currently only available for Linux / Mac OS X users. We are working on a version for Windows. In the meantime, Windows Users please use the <a href="Windows_-_Standalone">Standalone Installation</a></b></p>

      <p>This section details how to install and deploy a dockerized instance of the PDS Registry.
      </p>

      <ul>
        <li><a href="#Linux_/_Mac_OS_X_-_Docker">Linux / Mac OS X</a></li>
      </ul>
      
      <subsection name="Linux / Mac OS X - Docker">
	<p>The following Registry installation procedure is for Linux and Mac operating systems. Please contact Engineering Node if you run into any issues.</p>

        <ol>
          <li>
            <p>Install and Run Docker Desktop for Mac as indicated in <a href="https://docs.docker.com/docker-for-mac/install/" target="_blank">Install Docker Desktop for Mac</a> website if your system doesn't have Docker.</p>
          </li>
          
          <li>Move to the directory that registry installer script resides.
            <source>
% cd $REGISTRY_HOME/bin
            </source>
          </li>
          <li>Execute a registry installer script.
            <source>
% ./registry_install.sh
            </source>
          </li>
          <li>Enter the install mode (docker).
            <source>
Enter an installation mode (docker or standalone): docker
            </source>
                     
            <p>You should see output similar to the following:
          </p>

          <source>
STARTING Registry Installer in docker mode.

  Registry   .....   
       ( v 2.0.0 )
       ( installing on platform: Mac OS X )
       ( IP Address:- 192.168.1.65 )
       ( Host Name:- MT-106917 )

Execute to install Registry in Docker...
Building Registry Docker Image.                               SUCCESS
Starting Registry Docker Container.                           SUCCESS
Waiting for Solr server to start (60 seconds)...
Creating a Registry Service Blob collection (.system)                SUCCESS
Creating a Registry Service XPath collection (xpath)                 SUCCESS
Creating a Search collection (pds)                           SUCCESS
Completed to install Registry in Docker.

          </source>     
          </li>  
          <li>Verify installation.
            <p>Open up your favorite browser and type in <i>http://localhost:8983/solr</i>. You should see the Solr admin interface.
            </p>
          </li>
        </ol>
      </subsection>
    </section>
    
    <section name="Install Solr and Registry - Standalone">
      <p>This section of the Registry Installation guide is for installing Solr and the Registry as a standalone application outside of Docker. The Docker installation method is the preferred method, however, the standalone version is acceptable in certain circumstances. Please consult Engineering Node if you have any questions about what installation method you should pursue.
      </p>
      
      <ul>
        <li><a href="#Linux / Mac_OS_X_-_Standalone">Linux / Mac OS X</a></li>
        <li><a href="#Windows_-_Standalone">Windows</a></li>
      </ul>
      
      <subsection name="Linux / Mac OS X - Standalone">
        <ol>
          <li>
            <p><a href="https://www.apache.org/dyn/closer.lua/lucene/solr/7.7.2/solr-7.7.2.tgz">Download Solr</a>
	    </p>
            <p>Unpack Solr package and note the path to the Solr instance.<br />Note: It is preferred that the Solr package have same parent directory as Registry / Harvest.</p>
            <source>
              % tar -xvf solr-7.7.2.tgz
              % pwd
	      /home/pds

              % ls
	      harvest-x.x.x/
	      ${project.artifactId}-${project.version}/
	      solr-7.7.2/

	      # If different location, note location of SOLR
	      % cd solr-7.7.2/
	      % pwd
	      /home/pds/solr-7.7.2/
            </source>
          </li>
          <li>Move to the directory that registry installer script resides (Note: See <a href="#Unpacking_the_Package">Unpacking the Package</a> for configuring the REGISTRY_HOME variable or find out what that path represents.)
            <source>
              % cd $REGISTRY_HOME/bin
            </source>
          </li>
          <li>Execute the registry installer software:
            <source>
              % ./registry_install.sh
            </source>
          </li>
          <li>Enter the install mode and SOLR installation location that is done in previous step.
            <source>
              Enter an installation mode (docker or standalone): standalone
              
              Enter location of SOLR installation: /home/pds/solr-7.7.2
            </source>
            
            <p>You should see output similar to the following: </p>
            
            <source>
              STARTING Registry Installer in standalone mode.
              
              Registry   .....   
              ( v 2.0.0 )
              ( installing on platform: Mac OS X )
              ( IP Address:- 192.168.1.65 )
              ( Host Name:- MT-106917 )
              
              Enter location of SOLR installation: /Users/pds/SOLR/solr-7.7.2 
              Copied a directory from /Users/pds/registry/target/registry-2.0.0/bin/../dist to /Users/pds/SOLR/solr-7.7.2/contrib/pds/lib
              Copied a directory from /Users/pds/registry/target/registry-2.0.0/bin/../conf to /Users/pds/SOLR/solr-7.7.2/server/solr/configsets/pds/conf
              Copied a file from /Users/pds/registry/target/registry-2.0.0/bin/../lib/saxon-9.jar to /Users/pds/SOLR/solr-7.7.2/server/solr-webapp/webapp/WEB-INF/lib/saxon-9.jar
              Copied a file from /Users/pds/registry/target/registry-2.0.0/bin/../lib/saxon-dom-9.jar to /Users/pds/SOLR/solr-7.7.2/server/solr-webapp/webapp/WEB-INF/lib/saxon-dom-9.jar
              
              Starting a SOLR server ....Waiting up to 180 seconds to see Solr running on port 8983....
              *** [WARN] *** Your open file limit is currently 10240.  
              It should be set to 65000 to avoid operational disruption. 
              If you no longer wish to see this warning, set SOLR_ULIMIT_CHECKS to false in your profile or solr.in.sh
              *** [WARN] ***  Your Max Processes Limit is currently 1418. 
              It should be set to 65000 to avoid operational disruption. 
              If you no longer wish to see this warning, set SOLR_ULIMIT_CHECKS to false in your profile or solr.in.sh
              Waiting up to 180 seconds to see Solr running on port 8983 [-]  
              Started Solr server on port 8983 (pid=67836). Happy searching!
              
              
              Return status from the SOLR server startup = 0
              The SOLR server is started successfully.
              Creating Registry Service collection (.system) ...
              {
              "responseHeader":{
              "status":400,
              "QTime":45},
              "Operation create caused exception:":"org.apache.solr.common.SolrException:org.apache.solr.common.SolrException: collection already exists: .system",
              "exception":{
              "msg":"collection already exists: .system",
              "rspCode":400},
              "error":{
              "metadata":[
              "error-class","org.apache.solr.common.SolrException",
              "root-error-class","org.apache.solr.common.SolrException"],
              "msg":"collection already exists: .system",
              "code":400}}
              Return status from creating registry service collection (.system) = 0
              Registry service collection (.system) is created successfully.
              {
              "responseHeader":{
              "status":0,
              "QTime":122}}
              Return status from creating registry service collection alias = 0
              Registry service collection alias (.system) is created successfully.
              Creating Registry Service collection (xpath) ...
              {
              "responseHeader":{
              "status":0,
              "QTime":3528},
              "success":{
              "192.168.1.65:8983_solr":{
              "responseHeader":{
              "status":0,
              "QTime":1881},
              "core":"xpath_shard1_replica_n1"}},
              "warning":"Using _default configset. Data driven schema functionality is enabled by default, which is NOT RECOMMENDED for production use. To turn it off: curl http://{host:port}/solr/xpath/config -d '{\"set-user-property\": {\"update.autoCreateFields\":\"false\"}}'"}
              Registry service collection (xpath) is created successfully.
              {
              "responseHeader":{
              "status":0,
              "QTime":120}}
              Registry service collection alias (xpath) is created successfully.
              Creating Search collection (pds) ...
              Created collection 'pds' with 1 shard(s), 1 replica(s) with config-set 'pds'
              Return status from creating search collection = 0
              Search collection (pds) is created successfully.
              
            </source>        
          </li>
          <li>Verify installation.
            <p>Open up your favorite browser and type in <i>http://localhost:8983/solr</i> (replace localhost with hostname of the server). You should see the Solr admin interface. If not, there may be a port permissions issue. Consult your System Administrator to get the port accessible.
            </p>
          </li>
        </ol>
      </subsection> 
      
      <subsection name="Windows - Standalone">
        <ol>
	  <li>Install Curl

          <p>If Curl is not already installed on the target Windows machine, it can be downloaded from the <a href="https://curl.haxx.se/windows/">Curl</a> website. Make sure that the <i>PATH</i> environment references the bin/ folder in the Curl directory(i.e. C:\path\to\curl\bin).
          </p>

          </li>
          
          <li>Open Command Prompt via the <b><i>'Command Prompt'</i></b> executable.
          </li>

          <li>
            <p><a href="https://www.apache.org/dyn/closer.lua/lucene/solr/7.7.2/solr-7.7.2.zip">Download Solr</a></p> and unpack the zip file. Note this directory location.
            <p>From Command Prompty, go to directory of unpacked Solr software, and output the full path for future reference:</p>
            <source>
              $ cd solr-7.7.2
              
              # Set SOLR_HOME variable and note path that is output
              $ set "SOLR_HOME=%cd%"
              $ echo %SOLR_HOME%
              C:\home\pds\solr-7.7.2
            </source>      
          </li>

          <li>Now we go to where we unpacked the Registry, and move to the directory that registry installer script resides (See <a href="Unpacking_the_Package">Unpacking the Package</a> above.)
            <source>
              $ cd %REGISTRY_HOME%\bin
            </source>
          </li>
          <li>Execute Registry installer script.
            <source>
              $ registry_install.bat
            </source>
          </li>
          <li>Enter the install mode and SOLR installation location that is done in previous step.
            <source>
              Enter an installation mode (docker or standalone): standalone
              
              Enter location of SOLR installation: C:\home\pds\solr-7.7.2
            </source>
            
            <p>You should see output similar to the following: </p>
            
            <source>
              STARTING Registry Installer in standalone mode.
              
              Registry   .....   
              ( v 2.0.0 )
              ( installing on platform: Windows 7 )
              ( IP Address:- 192.168.1.65 )
              ( Host Name:- PDS-HP )
              
              Enter location of SOLR installation: C:\Users\pds\solr-7.7.2
              Copied a directory from C:\Users\pds\registry-2.0.0\bin\..\dist to C:\Users\pds\solr-7.7.2\contrib\pds\lib
              Copied a directory from C:\Users\pds\registry-2.0.0\bin\..\conf to C:\Users\pds\solr-7.7.2\server\solr\configs
              ets\pds\conf
              Copied a file from C:\Users\pds\registry-2.0.0\bin\..\lib\saxon-9.jar to C:\Users\pds\solr-7.7.2\server\solr-w
              ebapp\webapp\WEB-INF\lib\saxon-9.jar
              Copied a file from C:\Users\pds\registry-2.0.0\bin\..\lib\saxon-dom-9.jar to C:\Users\pds\solr-7.7.2\server\so
              lr-webapp\webapp\WEB-INF\lib\saxon-dom-9.jar
              
              Starting a SOLR server ....Waiting up to 180 seconds to see Solr running on port 8983....
              SOLR server is started on Windows 7
              Creating Registry Service collection (.system) ...
              {
              "responseHeader":{
              "status":0,
              "QTime":11259},
              "success":{
              "169.254.193.90:8983_solr":{
              "responseHeader":{
              "status":0,
              "QTime":7562},
              "core":".system_shard1_replica_n1"}},
              "warning":"Using _default configset. Data driven schema functionality is enabled by default, which is NOT RECOMMENDED for production use. To turn it off: curl http://{host:port}/solr/.system/config -d '{\"set-user-property\": {\"update.autoCreateFields\":\"false\"}}'"}
              Return status from creating registry service collection (.system) = 0
              Registry service collection (.system) is created successfully.
              {
              "responseHeader":{
              "status":0,
              "QTime":384}}
              Return status from creating registry service collection alias = 0
              Registry service collection alias (.system) is created successfully.
              Creating Registry Service collection (xpath) ...
              {
              "responseHeader":{
              "status":0,
              "QTime":17582},
              "success":{
              "169.254.193.90:8983_solr":{
              "responseHeader":{
              "status":0,
              "QTime":13858},
              "core":"xpath_shard1_replica_n1"}},
              "warning":"Using _default configset. Data driven schema functionality is enabled by default, which is NOT RECOMMENDED for production use. To turn it off: curl http://{host:port}/solr/xpath/config -d '{\"set-user-property\": {\"update.autoCreateFields\":\"false\"}}'"}
              Registry service collection (xpath) is created successfully.
              {
              "responseHeader":{
              "status":0,
              "QTime":355}}
              Registry service collection alias (xpath) is created successfully.
              Creating Search collection (pds) ...
              Created collection 'pds' with 1 shard(s), 1 replica(s) with config-set 'pds'
              Return status from creating search collection = 0
              Search collection (pds) is created successfully.
              
            </source>
          </li>
          <li>Verify installation.
            <p>Open up your favorite browser and type in <i>http://localhost:8983/solr</i>. You should see the Solr admin interface.
            </p>
          </li>
        </ol>
      </subsection>        
    </section>

    <section name="Operational Deployment">
      <p>Once you are ready to deploy the Registry operationally, you will want to secure Solr by setting up a reverse proxy in your Apache HTTP Server <i>httpd.conf</i> file:</p>
      <source>
        ProxyPass /services/registry/ http://localhost:8983/solr/
        ProxyPassReverse /services/registry/ http://localhost:8983/solr/
        ProxyPass /services/registry http://localhost:8983/solr
        ProxyPassReverse /services/registry http://localhost:8983/solr
        
        &lt;!-- Secures the Solr admin interface. Change your IP/subnet information accordingly. --&gt;
        &lt;Location "/services/registry/#/"&gt;
        Order Deny,Allow
        Deny from all
        Allow from 123.45.0.0/255.255.0.0 123.56.0.0/255.255.0.0 .jpl.nasa.gov
        &lt;/Location&gt;
      </source>
      
      <p>You should now be able to go to http://my.website.com/services/registry and see the Solr Admin interface.</p>
    </section>

    <section name="Next Steps">
      <subsection name="Install Harvest Tool">
        <p><a href="../../../ingest/harvest/index.html">The Harvest Tool</a> can be used to populate the Registry with data. The Harvest Tool runs locally at the Discipline Node to crawl the local data repository in order to discover products and index associated metadata with the Registry.</p>
      </subsection>
    </section>

    <section name="Common Errors">
      <subsection name="Failed to create a registry service collection (.system)...">
	<p>This issue could happen for several reasons, but we will need to look through the logs to determine the issue:
	</p>
	<ul>
	  <li>Look at Solr Console log to determine where the issue may lie:
	    <source>
# STANDALONE INSTALLATION
open $SOLR_HOME/server/logs/solr.log
open $SOLR_HOME/server/logs/solr-8983-console.log
	    </source>
	  </li>
	  <li>If the log output states:
	    <source>
Error occurred during initialization of VM
Could not reserve enough space for 2097152KB object heap
	    </source>
	    TBD solution
	  </li>
	</ul>
      </subsection>
      <subsection name="HTTP 404 - Requested Resource Not Available">
        <p>This error means the application failed to install correctly. The following are potential mitigation strategies:
        </p>
        <ul>
          <li>Verify domain and port are correct for the local Solr installation.</li>
          <li>View $SOLR_HOME/server/logs/solr.log for information on potential causes of the failed deployment.</li>
        </ul>
      </subsection>

      <subsection name="Other Errors">
        <p>For other errors that arise while testing the installation, see the <a href="../operate/index.html#Common_Errors">Operate - Common Errors</a></p>
      </subsection>
    </section>

  </body>
</document>
