<?xml version="1.0" encoding="UTF-8"?>

<!--
  Copyright 2011-2016, by the California Institute of Technology.
  ALL RIGHTS RESERVED. United States Government Sponsorship acknowledged.
  Any commercial use must be negotiated with the Office of Technology Transfer
  at the California Institute of Technology.

  This software is subject to U. S. export control laws and regulations
  (22 C.F.R. 120-130 and 15 C.F.R. 730-774). To the extent that the software
  is subject to U.S. export control laws and regulations, the recipient has
  the responsibility to obtain export licenses or other export authority as
  may be required before exporting such information to foreign countries or
  providing access to foreign nationals.

  $Id$
-->

<document>
  <properties>
    <title>Operation</title>
    <author email="Paul.Ramirez@jpl.nasa.gov">Paul Ramirez</author>
    <author email="Jordan.Padams@jpl.nasa.gov">Jordan Padams</author>
    <author email="Sean.Hardman@jpl.nasa.gov">Sean Hardman</author>
  </properties>

  <body>
    <section name="Operation">
      <p>The Registry is an Apache Solr adaptation that includes the Solr Admin interface along with the pre-installed collections that come with the PDS Registry and Search.  Once it is deployed, operations include modifying the configuration and leveraging the PDS and PDAP protocols to query data and metadata that has been extracted from PDS4 data products. The following topics will be covered below:
      </p>
      <ul>
	<li><a href="#Common_Operations">Common Operations</a></li>
	<ul>
	  <li><a href="#Add_Data_To_Registry_and_Search">Add Data To Registry and Search</a></li>
	  <li><a href="#Delete_Data_From_Registry_and_Search">Delete Data From Registry and Search</a></li>
	  <li><a href="#Re-Ingest_Data_To_Registry_and_Search">Re-Ingest Data To Registry and Search</a></li>
	</ul>
        <li><a href="#Administration_Interface">Administration Interface</a></li>
        <li><a href="#Configuration">Configuration</a></li>
	<ul>
	  <li><a href="#Add A Facet">Add A Facet</a></li>
	  <li><a href="#Update_Output_Format">Update Output Format</a></li>
	  <li><a href="#Add_a_Field_to_the_Schema">Add a Field to the Schema</a></li>
	  <li><a href="#Create_New_Search_Endpoint">Create New Search Endpoint</a></li>
	</ul>
        <li><a href="#Search_Protocols">Search Protocols</a></li>
        <li><a href="#Common_Errors">Common Errors</a></li>
      </ul>
    </section>

    <section name="Common Operations">
      <p>Here are some common operations you may wish to perform to interact with the Registry and Search. 
A tool to simplify these actions is in the plan, but in the meantime, here are the various raw commands you can do 
to modify data in your registry and search. 
For additional information for interacting with the Registry, please also take a look at 
the <a href="https://lucene.apache.org/solr/guide/7_6/collections-api.html">Solr Collections API</a> and other info 
on <a href="https://lucene.apache.org/solr/guide/7_7/overview-of-documents-fields-and-schema-design.html">interacting with Solr documents</a>.
</p>

      <subsection name="Add Data To Registry and Search">
        <p>Run <a href="../../../ingest/harvest/index.html">the Harvest Tool</a> to populate the Registry with data. 
The Harvest Tool runs locally at the Discipline Node to crawl the local data repository in order to discover products 
and index associated metadata with the Registry.</p>
        <p>When you run the Harvest Tool, some data will be loaded into the Registry by the tool.
Unfortunately, the current version of the Harvest Tool requires additional manual step to load some data into PDS Solr collection.</p> 
        <p>After you have run the Harvest Tool you should see one or more files like <i>solr_doc_0.xml</i>, <i>solr_doc_1.xml</i>
under <i>$REGISTRY_HOME/../registry-data/solr-docs</i> (or on Windows C:\\%REGISTRY_HOME%\..\registry-data\solr-docs). 
To ingest these files into the PDS Solr collection run the following command:
        </p>
        <p>Docker Installation:
        <source>
docker exec -it registry post -c pds -params "tr=add-hierarchy.xsl" /data/solr-docs
        </source>
        </p>
        <p>Standalone Installation:
        <source>
$SOLR_HOME/bin/post -c pds -params "tr=add-hierarchy.xsl" $REGISTRY_HOME/../registry-data/solr-docs
        </source>
        </p>
        <p>NOTE: There is no Solr post script for Windows. You will have to use a Unix environment such as MSYS2 or Cygwin.</p>
    </subsection>

	  <subsection name="Delete Data From Registry and Search">
	    <p>Once you have data in the Registry and/or Search, the following <a href="https://curl.haxx.se/download.html">cUrl</a> commands can modify the data you have ingested.
	    </p>

	    <p>Docker Installation:
	      <source>
# Clean out all data ingested into Registry and/or Search
docker exec -it registry post -c .system -d "&lt;delete&gt;&lt;query&gt;-type:metrics_rrd&lt;/query&gt;&lt;/delete&gt;"
docker exec -it registry post -c pds -d "&lt;delete&gt;&lt;query&gt;*:*&lt;/query>&lt;/delete&gt;"
docker exec -it registry post -c xpath -d "&lt;delete&gt;=&lt;query&gt;*:*&lt;/query>&lt;/delete&gt;"

# Remove collection with LIDVID = urn:nasa:pds:insight_rad:data_raw::1.0
docker exec -it registry post -c .system -d '&lt;delete&gt;&lt;query&gt;-type:metrics_rrd AND lidvid:"urn:nasa:pds:insight_rad:data_raw::1.0"&lt;/query&gt;&lt;/delete&gt;'
docker exec -it registry post -c pds -d '&lt;delete&gt;&lt;query&gt;lidvid:"urn:nasa:pds:insight_rad:data_raw::1.0"&lt;/query&gt;&lt;/delete&gt;'
docker exec -it registry post -c xpath -d '&lt;delete&gt;&lt;query&gt;lidvid:"urn:nasa:pds:insight_rad:data_raw::1.0"&lt;/query&gt;&lt;/delete&gt;'
	      </source>
	    </p>
	    
	    <p>Standalone Installation:
	      <source>
# Clean out all data ingested into Registry and/or Search
$SOLR_HOME/bin/post -c .system -d "&lt;delete&gt;&lt;query&gt;-type:metrics_rrd&lt;/query&gt;&lt;/delete&gt;"
$SOLR_HOME/bin/post -c pds -d "&lt;delete&gt;&lt;query&gt;*:*&lt;/query&gt;&lt;/delete&gt;"
$SOLR_HOME/bin/post -c xpath -d "&lt;delete&gt;&lt;query&gt;*:*&lt;/query&gt;&lt;/delete&gt;"

# Remove collection with LIDVID = urn:nasa:pds:insight_rad:data_raw::1.0
$SOLR_HOME/bin/post -c .system -d '&lt;delete&gt;&lt;query&gt;-type:metrics_rrd AND lidvid:"urn:nasa:pds:insight_rad:data_raw::1.0"&lt;/query&gt;&lt;/delete&gt;'
$SOLR_HOME/bin/post -c pds -d '&lt;delete&gt;&lt;query&gt;lidvid:"urn:nasa:pds:insight_rad:data_raw::1.0"&lt;/query&gt;&lt;/delete&gt;'
$SOLR_HOME/bin/post -c xpath -d '&lt;delete&gt;&lt;query&lt;lidvid:"urn:nasa:pds:insight_rad:data_raw::1.0"&lt;/query&gt;&lt;/delete&gt;'
	      </source>
	    </p>
	  </subsection>
	  <subsection name="Re-Ingest Data To Registry and Search">
	    <ul>
	      <li><a href="#Delete_Data_From_Registry_and_Search">Delete</a> the data you would like to remove from Registry and Search.</li>
	      <li>If you removed data from both the Registry and Search, you will need to re-run Harvest and then <a href="#Add_Data_To_Registry_and_Search">re-ingest the data</a> into the Search index.</li>
	      <li>If you only removed data from the Search index, you can then just <a href="#Add_Data_To_Registry_and_Search">re-ingest the data</a> into the Search index.</li>
	    </ul>
	  </subsection>
    </section>

    <section name="Administration Interface">
      <p>The Solr Administration Interface is available for advanced configuration and debugging of the Solr instance. The page can be viewed at <i>http://localhost:8983/solr</i> or if you have setup the proxy pass as directed in the installation guide, <i>https://&lt;hostname&gt;:8983/services/registry</i>. The following resources are available detailing the how to use this interface:
      </p>

      <ul>
        <li><a href="https://lucene.apache.org/solr/guide/7_7/overview-of-the-solr-admin-ui.html" target="_blank">Overview of the Solr Admin UI</a>
        </li>
        <li><a href="https://lucene.apache.org/solr/guide/6_6/using-the-solr-administration-user-interface.html" target="_blank">Using the Solr Administration User Interface</a>
        </li>
      </ul>

      <p>From the query page, you can perform various queries against the available <a href="../../images/search-service-endpoints.png">end points</a> supported by the service. Details regarding the supported query parameters can be found on the <a href="http://wiki.apache.org/solr/CommonQueryParameters" target="_blank">Common Query Parameters</a> page of the Solr wiki. The most useful of these being the <i>wt</i> parameter. When this parameter is specified as <i>wt=xslt</i>, you can view the output as it is queried from the Search UI and Product Search UI.
      </p>
    </section>

    <section name="Configuration">
      <p>The Registry comes preconfigured for supporting common PDS search terms and facets. That said, it can be tailored to support Discipline Node specific search requirements. See the <a href="http://lucene.apache.org/solr/" target="_blank">Apache Solr website</a> and <a href="http://wiki.apache.org/solr/" target="_blank">wiki</a> for more information on configuring Apache Solr. The sub-sections that follow detail the steps for performing some common configuration changes.
      </p>

      <subsection name="Add A Facet">
        <p>The following steps will allow a new facet to be added to the Registry output. The facets are the categories in the left sidebar of the Search UI that provide a means for browsing through the data. The name for the facet should not yet be a field in the schema, because a new field specifically dedicated to the faceting will be created. For instance, if you wanted to facet on <i>agency_name</i>, we will create a facet named <i>facet_agency</i>. These steps assume that the Registry was installed at <i>$REGISTRY_HOME</i>. If not, substitute the installation directory as needed. For the following example, we will be creating a facet on the <i>node_id</i> field.
        </p>

        <ol>
          <li><p>Add the following to the <i>$REGISTRY_HOME/conf/xslt/facets.xml</i> file:</p>
            <source>
&lt;facet name="facet node id" caption="Node" /&gt;
            </source>
          </li>
          <li><p>Update the <i>$REGISTRY_HOME/conf/xslt/add-hierarchy.xsl</i> file:</p>
            <source>
&lt;xsl:template match="field[@name = 'node_id']"&gt;
  &lt;xsl:copy-of select="." &gt;
  &lt;field name="facet_node_id"&gt;&lt;xsl:value-of select="concat('1,',.)" /&gt;&lt;/field&gt;
&lt;/xsl:template&gt;
            </source>
          </li>
          <li><p>Update the <i>$REGISTRY_HOME/conf/solrconfig.xml</i> file:</p>
            <source>
&lt;str name="facet.field"&gt;facet_node_id&lt;/str&gt;

&lt;str name="f.facet_node_id.facet.prefix"&gt;1,&lt;/str&gt;
            </source>
          </li>
          <li><p>Update the <i>$REGISTRY_HOME/conf/managed-schema</i> file by finding the area where facet fields are being declared (search for facet_) and add the following:</p>
            <source>
&lt;field name="facet_node" type="string_lc" indexed="true" stored="false" \
  multiValued="false" /&gt;
            </source>
          </li>
          <li>Execute the appropriate registry_uninstall and registry_install scripts (dependent upon operating system) to re-install the Registry with the new facets.</li>
        </ol>
      </subsection>

      <subsection name="Update Output Format">
        <p>The user interface components of the Registry may also be modified to tailor the look-and-feel of the search results.
        </p>

        <ul>
          <li>To update the output queried through the Search UI (<i>archive-filter</i> end point), make updates to the <i>$REGISTRY_HOME/conf/xslt/data-search.xsl</i> file.
          </li>
          <li>To update the output queried through the Product Search UI (<i>product-search</i> end point), make updates to the <i>$REGISTRY_HOME/conf/xslt/product-search.xsl</i> file.
          </li>
        </ul>
      </subsection>

      <subsection name="Add a Field to the Schema">
        <p>In order to add a field to the schema, modify the <i>$REGISTRY_HOME/conf/schema.xml</i> file. The following example will add the field <i>my_field</i>:
        </p>

        <source>
&lt;field name="my_field" type="text_general" indexed="true" stored="false" \
multiValued="false" /&gt;
        </source>

        <p>See the <a href="http://wiki.apache.org/solr/SchemaXml" target="_blank">Schema XML</a> page of the Solr wiki for more information on update the Solr schema.
        </p>
      </subsection>
    </section>

    <section name="Search Protocols">
      <p>The Registry provides two protocols for searching the contents of the service.
      </p>

      <subsection name="PDS Search Protocol">
        <p>See the <a href="../../docs/pds4_pds_search_protocol.pdf">PDS Search Protocol</a> document for more information on search terms and result formatting provided by this protocol. If viewing this document from the ${project.artifactId} package, view the <a href="https://pds-engineering.jpl.nasa.gov/development/pds4/current/search/docs/pds4_pds_search_protocol.pdf" target="_blank">PDS Search Protocol</a> document from the Engineering Node site.
        </p>
      </subsection>

      <subsection name="PDAP Protocol">
        <p>See the <a href="../../docs/pds4_pdap_search_protocol.pdf">PDAP Search Protocol</a> document for more information on search terms and result formatting provided by this protocol. If viewing this document from the ${project.artifactId} package, view the <a href="https://pds-engineering.jpl.nasa.gov/development/pds4/current/search/docs/pds4_pdap_search_protocol.pdf" target="_blank">PDAP Search Protocol</a> document from the Engineering Node site.
        </p>
      </subsection>
    </section>

    <section name="Common Errors">
      TBD
    </section>
  </body>
</document>
